name: Monthly Expense Report

on:
  # Run on the 1st of each month at 7:00 AM UTC (8:00 AM CET)
  schedule:
    - cron: '0 7 1 * *'
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      send_email:
        description: 'Send email notification'
        required: false
        type: boolean
        default: true

jobs:
  generate-and-send-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Requirements.txt
      
      - name: Generate dashboard, upload to Drive, and send email
        env:
          DASHBOARD_TITLE: ${{ vars.DASHBOARD_TITLE }}
          api_key: ${{ secrets.SPLITWISE_API_KEY }}
          group_id: ${{ secrets.SPLITWISE_GROUP_ID }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          RECIPIENT_EMAIL: ${{ vars.RECIPIENT_EMAIL }}
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          ARGS=""
          
          # Scheduled runs: always send email
          if [ "${{ github.event_name }}" = "schedule" ]; then
            ARGS="--email"
          else
            # Manual runs: check send_email input
            if [ "${{ inputs.send_email }}" = "true" ]; then
              ARGS="--email"
            fi
          fi
          
          python family_expenses.py $ARGS
