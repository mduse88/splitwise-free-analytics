<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Family Expenses Dashboard</title>
    <script defer src="/__/firebase/12.6.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.6.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/12.6.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js"></script>
    <style>
        /* Login page styles - scoped to avoid conflicts with dashboard */
        body:not(.authenticated) { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; padding: 0; }
        body.authenticated { display: block; }
        #login-container { background: rgba(255, 255, 255, 0.95); padding: 48px 40px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4); text-align: center; max-width: 400px; width: 90%; }
        #login-container .logo { font-size: 48px; margin-bottom: 16px; }
        #login-container h1 { color: #1a1a2e; font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        #login-container .subtitle { color: #666; font-size: 14px; margin-bottom: 32px; }
        #sign-in-btn { display: inline-flex; align-items: center; gap: 12px; background: #4285f4; color: white; border: none; padding: 14px 28px; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 14px rgba(66, 133, 244, 0.4); }
        #sign-in-btn:hover { background: #3367d6; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(66, 133, 244, 0.5); }
        .google-icon { width: 20px; height: 20px; background: white; border-radius: 4px; padding: 2px; }
        #login-container #error { color: #dc3545; font-size: 14px; margin-top: 20px; padding: 12px; background: #fff5f5; border-radius: 8px; display: none; }
        #sign-out-btn { display: none; margin-top: 16px; background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: background 0.2s ease; }
        #sign-out-btn:hover { background: #5a6268; }
        #login-container #loading { color: #666; font-size: 14px; margin-top: 20px; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #ccc; border-top-color: #4285f4; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        #dashboard-container { display: none; width: 100%; min-height: 100vh; }
        body.authenticated #dashboard-container { display: block; }
        body.authenticated #login-container { display: none; }
    </style>
</head>
<body>
    <div id="login-container">
        <div class="logo">ðŸ“Š</div>
        <h1>Family Expenses</h1>
        <p class="subtitle">Sign in to view your expense dashboard</p>
        <button id="sign-in-btn" onclick="signIn()">
            <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Sign in with Google
        </button>
        <div id="error"></div>
        <button id="sign-out-btn" onclick="signOut()">Try a different account</button>
        <div id="loading" class="hidden"><span class="spinner"></span>Checking authorization...</div>
    </div>
    <div id="dashboard-container"></div>
    <script id="dashboard-data" type="text/plain">__DASHBOARD_DATA_PLACEHOLDER__</script>
    <script>
        // Security: Store hashes for client-side auth check
        const ALLOWED_HASHES = __ALLOWED_HASHES_PLACEHOLDER__;
        // Fallback key (null if key is in Firestore, hex string if fallback)
        const FALLBACK_KEY = __ENCRYPTION_KEY_PLACEHOLDER__;
        
        // Hash email using SHA-256 (matches server-side hashing)
        async function hashEmail(email) {
            const encoder = new TextEncoder();
            const data = encoder.encode(email.toLowerCase().trim());
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Convert hex string to Uint8Array
        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }
        
        // Fetch encryption key from Firestore (secure, requires auth)
        async function fetchKeyFromFirestore() {
            try {
                const db = firebase.firestore();
                const doc = await db.collection('config').doc('dashboard').get();
                if (doc.exists) {
                    const data = doc.data();
                    return data.encryptionKey;
                }
            } catch (e) {
                console.error('Failed to fetch key from Firestore:', e);
            }
            return null;
        }
        
        // Import raw key bytes as CryptoKey
        async function importKey(keyHex) {
            const keyBytes = hexToBytes(keyHex);
            return await crypto.subtle.importKey(
                'raw',
                keyBytes,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            );
        }
        
        // Decrypt AES-GCM encrypted dashboard
        async function decryptDashboard(encryptedHex, keyHex) {
            const encrypted = hexToBytes(encryptedHex);
            const nonce = encrypted.slice(0, 12);  // First 12 bytes are nonce
            const ciphertext = encrypted.slice(12);  // Rest is ciphertext + tag
            
            const key = await importKey(keyHex);
            
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: nonce },
                key,
                ciphertext
            );
            
            return new TextDecoder().decode(decrypted);
        }
        
        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider).catch(error => { showError('Sign-in failed: ' + error.message); });
        }
        function signOut() { firebase.auth().signOut(); }
        function showError(message, showSignOut = false) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('sign-out-btn').style.display = showSignOut ? 'inline-block' : 'none';
        }
        async function showDashboard() {
            const encryptedData = document.getElementById('dashboard-data').textContent.trim();
            if (encryptedData && !encryptedData.includes('PLACEHOLDER')) {
                try {
                    // Get encryption key (from Firestore or fallback)
                    let keyHex = FALLBACK_KEY;
                    if (!keyHex) {
                        keyHex = await fetchKeyFromFirestore();
                        if (!keyHex) {
                            throw new Error('Could not retrieve encryption key');
                        }
                    }
                    
                    // Decrypt the dashboard using AES-GCM
                    const dashboardHtml = await decryptDashboard(encryptedData, keyHex);
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(dashboardHtml, 'text/html');
                    doc.querySelectorAll('style').forEach(style => { document.head.appendChild(style.cloneNode(true)); });
                    document.getElementById('dashboard-container').innerHTML = doc.body.innerHTML;
                    const externalScripts = [];
                    const inlineScripts = [];
                    doc.querySelectorAll('script').forEach(script => {
                        if (script.src) { externalScripts.push(script.src); }
                        else if (script.textContent.trim()) { inlineScripts.push(script.textContent); }
                    });
                    function loadExternalScripts(urls, callback) {
                        if (urls.length === 0) { callback(); return; }
                        let loaded = 0;
                        urls.forEach(url => {
                            const s = document.createElement('script');
                            s.src = url;
                            s.onload = s.onerror = () => { loaded++; if (loaded === urls.length) callback(); };
                            document.body.appendChild(s);
                        });
                    }
                    loadExternalScripts(externalScripts, () => {
                        inlineScripts.forEach(code => { const s = document.createElement('script'); s.textContent = code; document.body.appendChild(s); });
                    });
                    document.body.classList.add('authenticated');
                } catch (e) { showError('Failed to decrypt dashboard: ' + e.message); }
            } else { showError('Dashboard content not available'); }
        }
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                firebase.auth().onAuthStateChanged(async user => {
                    if (user) {
                        document.getElementById('loading').classList.remove('hidden');
                        document.getElementById('sign-in-btn').classList.add('hidden');
                        const userHash = await hashEmail(user.email);
                        if (ALLOWED_HASHES.includes(userHash)) { await showDashboard(); }
                        else { showError('Access denied. Your account is not authorized.', true); }
                    } else {
                        document.body.classList.remove('authenticated');
                        document.getElementById('login-container').classList.remove('hidden');
                        document.getElementById('sign-in-btn').classList.remove('hidden');
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('error').style.display = 'none';
                        document.getElementById('sign-out-btn').style.display = 'none';
                    }
                });
            }, 500);
        });
    </script>
</body>
</html>